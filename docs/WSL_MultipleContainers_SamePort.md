# **WSLで複数コンテナを同一ポートで動かすためのIPアドレス設定手順**

## **1\. はじめに**

Windows Subsystem for Linux (WSL) 上で開発を行う際、複数のコンテナを同時に起動したい場面はよくあります。しかし、通常の方法でコンテナを起動すると、同じポート番号を複数のコンテナで使用できない「ポート競合」の問題が発生します。

本番環境では、各サービスインスタンスが異なるサーバー（異なるIPアドレス）で稼働し、同じポート番号（例: 8000）を使用することが一般的です。開発環境でもこの構成を再現したいというニーズは少なくありません。

このドキュメントでは、**WSL環境自体に複数の仮想IPアドレスを割り当て、それぞれのIPアドレスにコンテナを紐付ける**ことで、ポート番号を変更することなく複数のコンテナを同一ポートで稼働させる方法を解説します。

## **2\. 実現したい構成**

\[画像: 構成図。Windowsホストから、IPアドレスが異なるWSL上の2つのコンテナ（例: 172.20.10.2:8000 と 172.20.10.3:8000）にそれぞれ接続している様子\]

* **課題**: 2つのコンテナを、両方ともポート 8000 で起動したいが、通常はポートが競合してしまい、2つ目のコンテナが起動できない。  
* **解決策**: WSLのネットワークインターフェース（eth0）に、元々あるIPアドレスに加えて、セカンダリIPアドレスを複数追加する。そして、Podman（またはDocker）でコンテナを起動する際に、公開するIPアドレスを明示的に指定する。  
* **結果**:  
  * コンテナA → 172.20.10.2:8000 で待機  
  * コンテナB → 172.20.10.3:8000 で待機  
  * 上記のように、IPアドレスが異なるため、同じポート番号 8000 を使用しても競合が発生しない。

## **3\. 設定手順**

### **ステップ1: WSLの現在のIPアドレスを確認する**

まず、WSL環境の基準となるIPアドレスとネットワーク範囲を確認します。WSLのUbuntuターミナルで以下のコマンドを実行してください。

ip addr show eth0

実行すると、以下のような情報が表示されます。inet の行に注目してください。

2: eth0: \<BROADCAST,MULTICAST,UP,LOWER\_UP\> mtu 1500 qdisc mq state UP group default qlen 1000  
    link/ether 00:15:5d:63:8a:75 brd ff:ff:ff:ff:ff:ff  
    inet 172.20.10.1/20 brd 172.20.15.255 scope global eth0  
       valid\_lft forever preferred\_lft forever  
    inet6 fe80::215:5dff:fe63:8a75/64 scope link  
       valid\_lft forever preferred\_lft forever

この例では、WSLのプライマリIPアドレスが 172.20.10.1 で、サブネットマスクが /20 であることがわかります。この情報を基に、追加するIPアドレスを決定します。

### **ステップ2: WSLにセカンダリIPアドレスを追加する**

次に、コンテナに割り当てるための新しいIPアドレス（セカンダリIPアドレス）をWSLに追加します。sudo ip addr add コマンドを使用し、ステップ1で確認したIPアドレスと**同じネットワーク範囲内**で、まだ使われていないIPアドレスを指定します。

ここでは例として、2つのコンテナ用に2つのIPアドレスを追加します。

\# 1つ目のセカンダリIPアドレスを追加  
sudo ip addr add 172.20.10.2/20 dev eth0

\# 2つ目のセカンダリIPアドレスを追加  
sudo ip addr add 172.20.10.3/20 dev eth0

**【注意】**

* 172.20.10.2/20 の部分は、ご自身の環境に合わせて変更してください。  
* このコマンドで追加したIPアドレスは一時的なもので、WSLを再起動すると失われます。永続化する方法は後述します。

### **ステップ3: 各IPアドレスにコンテナを紐付けて起動する**

Podmanでコンテナを起動します。-p (publish) オプションで、\[指定IPアドレス\]:\[ホスト側ポート\]:\[コンテナ側ポート\] の形式で指定します。

今回は、本番環境と同じポート番号を使いたいため、ホスト側とコンテナ側のポート番号を同じにします。

* 1台目のコンテナ（端末1）を起動:  
  172.20.10.2 のポート 8000 に紐付けます。  
  podman run \-d \--name backend-instance-1 \-p 172.20.10.2:8000:8000 your-backend-image

* 2台目のコンテナ（端末2）を起動:  
  172.20.10.3 のポート 8000 に紐付けます。  
  podman run \-d \--name backend-instance-2 \-p 172.20.10.3:8000:8000 your-backend-image

これで、2つのコンテナがそれぞれ異なるIPアドレスのポート 8000 で起動しました。フロントエンドやテストツールからは、以下のエンドポイントに接続することで、各コンテナにアクセスできます。

* コンテナ1のエンドポイント: http://172.20.10.2:8000  
* コンテナ2のエンドポイント: http://172.20.10.3:8000

## **4\. (推奨) IPアドレス追加処理の自動化**

WSLを再起動するたびに sudo ip addr add コマンドを手動で実行するのは非効率です。WSLの起動時にIPアドレスが自動で追加されるように設定することをお勧めします。

簡単な方法は、シェルの設定ファイル（例: .bashrc）にコマンドを追記することです。

1. ホームディレクトリにある .bashrc ファイルをエディタで開きます。  
   nano \~/.bashrc

2. ファイルの末尾に、IPアドレスを追加するコマンドを追記します。IPアドレスが既に追加されている場合にエラーが出ないように、簡単なチェックを入れるとより確実です。  
   \# \--- WSL起動時にセカンダリIPを追加 \---  
   if \! ip addr show dev eth0 | grep \-q "172.20.10.2/20"; then  
     sudo ip addr add 172.20.10.2/20 dev eth0  
   fi

   if \! ip addr show dev eth0 | grep \-q "172.20.10.3/20"; then  
     sudo ip addr add 172.20.10.3/20 dev eth0  
   fi  
   \# \------------------------------------

3. ファイルを保存して閉じます。

これで、新しいターミナルを開くたびにIPアドレスの存在がチェックされ、なければ追加されるようになります。

補足: sudoのパスワード入力について  
上記の方法では、ターミナルを開くたびに sudo のパスワードを求められる場合があります。これを避けるには、visudo コマンドを使って ip コマンドをパスワードなしで実行できるように設定する必要がありますが、設定には十分注意してください。