# language: ja

フィーチャー: 請求・売上管理
  キャッシュフローの最適化と売掛金管理の強化のため
  営業担当者および経理担当者として
  見積から入金までの一連のプロセスを効率的に管理したい

  背景:
    前提 以下のユーザーが存在する:
      | ユーザー名 | 役割 | 部門 |
      | 営業太郎 | 営業担当 | 営業部 |
      | 営業花子 | 営業マネージャー | 営業部 |
      | 経理次郎 | 経理担当 | 財務部 |
      | 財務部長 | 部長 | 財務部 |
    かつ 以下の顧客が登録されている:
      | 顧客コード | 顧客名 | 与信限度額 | 支払条件 |
      | CUST-001 | 株式会社ABC商事 | 10,000,000 | 月末締翌月末払 |
      | CUST-002 | XYZ工業株式会社 | 5,000,000 | 月末締翌々月末払 |
      | CUST-003 | 田中商店 | 1,000,000 | 都度現金 |
    かつ 以下の商品・サービスが登録されている:
      | 商品コード | 商品名 | 単価 | 税率 |
      | SRV-001 | コンサルティング（月額） | 500,000 | 10% |
      | SRV-002 | システム開発（人月） | 800,000 | 10% |
      | PRD-001 | ソフトウェアライセンス | 300,000 | 10% |
      | PRD-002 | 保守サービス（年額） | 120,000 | 10% |

  シナリオ: 見積書の作成（テンプレート使用）
    前提 営業太郎としてログインしている
    もし 「見積作成」メニューを選択する
    かつ 「新規見積」ボタンをクリックする
    かつ 顧客として「株式会社ABC商事」を選択する
    かつ テンプレートとして「システム開発見積」を選択する
    ならば テンプレートの項目が自動入力される:
      | 項目 | 内容 | 数量 | 単価 | 金額 |
      | 要件定義 | 要件定義・基本設計 | 1 | 1,500,000 | 1,500,000 |
      | 開発作業 | 詳細設計・実装・テスト | 3 | 800,000 | 2,400,000 |
      | 導入支援 | 導入・移行支援 | 0.5 | 800,000 | 400,000 |
    もし 以下の項目を追加する:
      | 項目 | 内容 | 数量 | 単価 | 金額 |
      | 保守サービス | 初年度保守（年額） | 1 | 480,000 | 480,000 |
    かつ 値引きとして「5%」を設定する
    かつ 有効期限を「2024/08/31」に設定する
    かつ 「見積書作成」ボタンをクリックする
    ならば 見積書が作成される:
      | 項目 | 金額 |
      | 小計 | 4,780,000 |
      | 値引き（5%） | -239,000 |
      | 課税対象額 | 4,541,000 |
      | 消費税（10%） | 454,100 |
      | 合計 | 4,995,100 |
    かつ 見積番号「QT-2024-0715-001」が発行される
    かつ 承認申請が営業花子に送信される

  シナリオ: 見積書の承認とPDF出力
    前提 営業花子としてログインしている
    かつ 見積書「QT-2024-0715-001」の承認依頼が届いている
    もし 承認待ち一覧から見積書を選択する
    かつ 内容を確認する
    かつ 「承認」ボタンをクリックする
    ならば 見積書が承認される
    かつ 営業太郎に承認通知が送信される
    
    前提 営業太郎としてログインしている
    もし 承認済み見積書「QT-2024-0715-001」を開く
    かつ 「PDF出力」ボタンをクリックする
    ならば 見積書PDFが生成される
    かつ PDFに会社ロゴと印影が表示される
    かつ 「メール送信」ボタンが有効になる
    もし 「メール送信」ボタンをクリックする
    かつ 宛先として「abc-eigyo@example.com」を入力する
    かつ 「送信」ボタンをクリックする
    ならば 見積書がメールで送信される
    かつ 送信履歴が記録される

  シナリオ: 見積書から請求書への変換
    前提 営業太郎としてログインしている
    かつ 見積書「QT-2024-0715-001」が受注確定している
    もし 見積書詳細画面を開く
    かつ 「請求書作成」ボタンをクリックする
    ならば 請求書作成画面が表示される
    かつ 見積内容が自動的に転記される
    もし 請求条件として以下を設定する:
      | 項目 | 値 |
      | 請求日 | 2024/07/31 |
      | 支払期限 | 2024/08/31 |
      | 請求方法 | 一括請求 |
    かつ 「請求書発行」ボタンをクリックする
    ならば 請求書が発行される
    かつ 請求番号「INV-2024-0731-001」が採番される
    かつ 売掛金4,995,100円が自動計上される

  シナリオ: インボイス制度対応の請求書発行
    前提 営業太郎としてログインしている
    かつ 適格請求書発行事業者として登録されている
    もし 新規請求書を作成する
    かつ 顧客として「XYZ工業株式会社」を選択する
    かつ 以下の明細を入力する:
      | 品目 | 数量 | 単価 | 税率 |
      | コンサルティング | 2 | 500,000 | 10% |
      | 会議費（軽減税率） | 1 | 10,000 | 8% |
    かつ 「請求書発行」ボタンをクリックする
    ならば 適格請求書が発行される
    かつ 以下の項目が自動表示される:
      | 項目 | 内容 |
      | 登録番号 | T1234567890123 |
      | 10%対象 | 1,000,000円（税額100,000円） |
      | 8%対象 | 10,000円（税額800円） |
      | 合計額 | 1,110,800円 |
    かつ 税率ごとの区分記載がされる

  シナリオ: 分割請求の設定
    前提 営業太郎としてログインしている
    かつ プロジェクト総額6,000,000円の案件がある
    もし 「請求書作成」画面で「分割請求」を選択する
    かつ 以下の分割条件を設定する:
      | 回数 | 請求時期 | 金額 | 内容 |
      | 1 | 契約時 | 2,000,000 | 着手金 |
      | 2 | 2024/09/30 | 2,000,000 | 中間金 |
      | 3 | 2024/12/31 | 2,000,000 | 最終納品時 |
    かつ 「分割請求作成」ボタンをクリックする
    ならば 3件の請求予定が作成される
    かつ 初回請求書が即時発行される
    かつ 2回目以降は請求予定として登録される
    かつ 請求予定日にリマインダーが設定される

  シナリオ: 定期請求の自動生成
    前提 経理次郎としてログインしている
    かつ 以下の定期請求が設定されている:
      | 顧客 | サービス | 金額 | 頻度 | 次回請求日 |
      | ABC商事 | 保守サービス | 40,000 | 毎月 | 2024/07/31 |
      | XYZ工業 | コンサルティング | 500,000 | 毎月 | 2024/07/31 |
    もし システム日付が2024/07/31になる
    ならば 定期請求バッチが自動実行される
    かつ 2件の請求書が自動生成される
    かつ 請求書PDFが自動作成される
    かつ 各顧客にメールで自動送信される
    かつ 次回請求日が2024/08/31に更新される

  シナリオ: 銀行入金データの取り込みと自動消込
    前提 経理次郎としてログインしている
    かつ 以下の売掛金が存在する:
      | 請求番号 | 顧客 | 請求額 | 請求日 |
      | INV-001 | ABC商事 | 1,100,000 | 2024/06/30 |
      | INV-002 | XYZ工業 | 550,000 | 2024/06/30 |
      | INV-003 | 田中商店 | 110,000 | 2024/07/15 |
    もし 「入金取込」メニューを選択する
    かつ 銀行入金ファイルをアップロードする:
      """
      2024/07/31,ｶﾌﾞ)ABCｼｮｳｼﾞ,1100000,普通預金
      2024/07/31,XYZｺｳｷﾞｮｳ(ｶ,550000,普通預金
      2024/07/31,ﾀﾅｶｼｮｳﾃﾝ,108000,普通預金
      """
    かつ 「取込実行」ボタンをクリックする
    ならば 入金データが取り込まれる
    かつ 自動消込が実行される:
      | 請求番号 | 消込結果 | 入金額 | 差額 |
      | INV-001 | 完全一致 | 1,100,000 | 0 |
      | INV-002 | 完全一致 | 550,000 | 0 |
      | INV-003 | 一部不足 | 108,000 | -2,000 |
    かつ 消込結果の確認画面が表示される

  シナリオ: 手動消込と過不足処理
    前提 経理次郎としてログインしている
    かつ 田中商店の請求110,000円に対して108,000円の入金がある
    もし 消込確認画面で「手動消込」を選択する
    かつ 不足分2,000円の処理方法として「値引処理」を選択する
    かつ 理由として「端数値引き」を入力する
    かつ 「消込実行」ボタンをクリックする
    ならば 売掛金が消込される
    かつ 以下の仕訳が自動生成される:
      """
      借方：現金 108,000 / 貸方：売掛金 108,000
      借方：売上値引 2,000 / 貸方：売掛金 2,000
      """
    かつ 値引き処理の承認申請が財務部長に送信される

  シナリオ: 売掛金エージング分析
    前提 経理次郎としてログインしている
    もし 「売掛金管理」メニューを選択する
    かつ 基準日として「2024/07/31」を指定する
    ならば 売掛金エージングレポートが表示される:
      | 顧客 | 0-30日 | 31-60日 | 61-90日 | 91日以上 | 合計 |
      | ABC商事 | 2,200,000 | 1,100,000 | 0 | 0 | 3,300,000 |
      | XYZ工業 | 550,000 | 1,650,000 | 550,000 | 0 | 2,750,000 |
      | 田中商店 | 0 | 0 | 220,000 | 110,000 | 330,000 |
      | 合計 | 2,750,000 | 2,750,000 | 770,000 | 110,000 | 6,380,000 |
    かつ 与信限度額に対する使用率が表示される:
      | 顧客 | 与信限度額 | 売掛残高 | 使用率 | ステータス |
      | ABC商事 | 10,000,000 | 3,300,000 | 33% | 正常 |
      | XYZ工業 | 5,000,000 | 2,750,000 | 55% | 注意 |
      | 田中商店 | 1,000,000 | 330,000 | 33% | 要注意（長期滞留） |

  シナリオ: 自動督促の実行
    前提 システムは毎日督促チェックを実行している
    かつ 田中商店の請求「INV-2024-0430-001」が支払期限を60日超過している
    もし 督促バッチが実行される
    ならば 以下の督促プロセスが開始される:
      | 段階 | 超過日数 | アクション |
      | 第1次 | 30日 | リマインダーメール送信済み |
      | 第2次 | 60日 | 督促状（PDF）の自動生成・送信 |
      | 第3次 | 90日 | 営業担当への通知 |
    かつ 督促状が生成される:
      """
      田中商店 御中
      
      督促状
      
      下記の通り、お支払いが確認できておりません。
      至急ご確認の上、お支払いください。
      
      請求番号：INV-2024-0430-001
      請求日：2024/04/30
      請求額：110,000円
      支払期限：2024/05/31
      超過日数：61日
      
      なお、○月○日までにお支払いが確認できない場合は、
      やむを得ず法的措置を検討させていただきます。
      """
    かつ 営業太郎に顧客フォローの通知が送信される

  シナリオ: 売上レポートと入金予測
    前提 財務部長としてログインしている
    もし 「売上分析」メニューを選択する
    かつ 期間として「2024年7月」を指定する
    ならば 以下の売上サマリーが表示される:
      | 項目 | 金額 | 前年同月比 |
      | 売上高 | 15,500,000 | +12.5% |
      | 請求額 | 16,000,000 | +15.0% |
      | 入金額 | 14,800,000 | +8.0% |
      | 売掛残高 | 6,380,000 | +5.5% |
    かつ 向こう3ヶ月の入金予測が表示される:
      | 月 | 予定入金額 | 確度 |
      | 8月 | 12,000,000 | 95% |
      | 9月 | 8,500,000 | 85% |
      | 10月 | 6,000,000 | 70% |
    かつ キャッシュフロー予測グラフが表示される