# language: ja

フィーチャー: 経費管理
  業務効率化とコンプライアンス強化のため
  従業員として
  経費の申請、承認、精算を円滑に行いたい

  背景:
    前提 以下のユーザーが存在する:
      | ユーザー名 | 役割 | 部門 | 上長 |
      | 山田太郎 | 一般社員 | 営業部 | 鈴木一郎 |
      | 鈴木一郎 | 課長 | 営業部 | 田中部長 |
      | 田中部長 | 部長 | 営業部 | 佐藤役員 |
      | 佐藤役員 | 役員 | 経営企画 | - |
      | 経理花子 | 経理担当 | 財務部 | - |
    かつ 以下の承認ルールが設定されている:
      | 金額範囲 | 承認者 |
      | ～10,000円 | 直属上長 |
      | 10,001円～100,000円 | 部長 |
      | 100,001円～ | 役員 |
    かつ 以下の経費種別が登録されている:
      | 種別コード | 種別名 | 領収書必須 | 事前申請必須 |
      | TRANS | 交通費 | いいえ | いいえ |
      | MEET | 会議費 | はい | いいえ |
      | ENTERTAIN | 接待交際費 | はい | はい |
      | SUPPLY | 消耗品費 | はい | いいえ |
      | TRAVEL | 出張旅費 | はい | はい |

  シナリオ: 通常の経費申請（モバイル）
    前提 山田太郎としてモバイルアプリでログインしている
    もし 「経費申請」メニューをタップする
    かつ 「新規申請」ボタンをタップする
    かつ 以下の経費情報を入力する:
      | 項目 | 値 |
      | 日付 | 2024/07/15 |
      | 経費種別 | 交通費 |
      | 金額 | 2,340 |
      | 経路 | 東京→横浜（往復） |
      | 目的 | A社訪問 |
      | プロジェクト | PRJ-2024-001 |
    かつ 「申請」ボタンをタップする
    ならば 経費申請が登録される
    かつ 申請番号「EXP-2024-0715-001」が発行される
    かつ 鈴木一郎に承認依頼通知が送信される
    かつ 申請ステータスが「承認待ち」と表示される

  シナリオ: 領収書のOCR読み取り
    前提 山田太郎としてモバイルアプリでログインしている
    かつ 経費申請画面を開いている
    もし 「領収書撮影」ボタンをタップする
    かつ カメラで領収書を撮影する
    かつ OCR読み取りが実行される
    ならば 以下の情報が自動入力される:
      | 項目 | 読み取り値 |
      | 日付 | 2024/07/14 |
      | 金額 | 5,500 |
      | 支払先 | レストラン山田 |
    かつ 「この内容で申請」ボタンが表示される
    もし 経費種別として「会議費」を選択する
    かつ 参加者として「顧客：A社 山田様、田中様」を入力する
    かつ 「申請」ボタンをタップする
    ならば 領収書画像付きで経費申請が登録される

  シナリオ: 多段階承認フロー
    前提 山田太郎が以下の経費を申請している:
      | 申請番号 | 日付 | 種別 | 金額 | ステータス |
      | EXP-001 | 2024/07/01 | 接待交際費 | 150,000 | 承認待ち |
    かつ 鈴木一郎としてログインしている
    もし 承認待ち一覧を開く
    ならば 申請「EXP-001」が表示される
    もし 申請「EXP-001」の詳細を確認する
    かつ 「承認」ボタンをクリックする
    かつ コメント「顧客との重要商談のため承認」を入力する
    ならば 一次承認が完了する
    かつ 田中部長に承認依頼が転送される
    かつ 申請ステータスが「部長承認待ち」に変更される
    
    前提 田中部長としてログインしている
    もし 承認待ち一覧を開く
    かつ 申請「EXP-001」を承認する
    ならば 二次承認が完了する
    かつ 佐藤役員に承認依頼が転送される
    かつ 申請ステータスが「役員承認待ち」に変更される
    
    前提 佐藤役員としてログインしている
    もし 承認待ち一覧を開く
    かつ 申請「EXP-001」を承認する
    ならば 最終承認が完了する
    かつ 山田太郎に承認完了通知が送信される
    かつ 申請ステータスが「承認済み」に変更される
    かつ 経理部門の精算待ちリストに追加される

  シナリオ: 経費の差戻し
    前提 山田太郎が金額50,000円の会議費を申請している
    かつ 鈴木一郎としてログインしている
    もし 申請の詳細を確認する
    かつ 領収書の内容が不明瞭である
    かつ 「差戻し」ボタンをクリックする
    かつ 差戻し理由として「領収書の但し書きが不明瞭です。詳細を追記してください」を入力する
    ならば 申請が差し戻される
    かつ 山田太郎に差戻し通知が送信される
    かつ 申請ステータスが「差戻し」に変更される
    
    前提 山田太郎としてログインしている
    もし 差戻された申請を開く
    かつ 但し書きとして「新製品説明会（参加者10名）」を追記する
    かつ 「再申請」ボタンをクリックする
    ならば 申請が再提出される
    かつ 鈴木一郎に再承認依頼が送信される

  シナリオ: 定期経費の自動申請
    前提 山田太郎としてログインしている
    もし 「定期経費設定」メニューを選択する
    かつ 「新規登録」ボタンをクリックする
    かつ 以下の定期経費を設定する:
      | 項目 | 値 |
      | 経費名 | 定期券代 |
      | 種別 | 交通費 |
      | 金額 | 15,000 |
      | 頻度 | 毎月 |
      | 申請日 | 毎月25日 |
      | 期間 | 2024/04/01-2025/03/31 |
      | 自動承認 | あり |
    かつ 「登録」ボタンをクリックする
    ならば 定期経費が登録される
    かつ 次回申請予定日が「2024/07/25」と表示される
    
    前提 システム日付が2024/07/25になる
    ならば 定期券代15,000円の経費が自動申請される
    かつ 事前承認設定により自動承認される
    かつ 山田太郎に自動申請完了通知が送信される

  シナリオ: 仮払金の申請と精算
    前提 山田太郎としてログインしている
    もし 「仮払申請」メニューを選択する
    かつ 以下の情報を入力する:
      | 項目 | 値 |
      | 目的 | 大阪出張 |
      | 期間 | 2024/07/20-2024/07/22 |
      | 概算金額 | 80,000 |
      | 内訳 | 交通費30,000円、宿泊費40,000円、その他10,000円 |
    かつ 「申請」ボタンをクリックする
    ならば 仮払申請が登録される
    かつ 承認フローに従って処理される
    
    前提 仮払金80,000円が承認され振り込まれている
    かつ 出張から戻った
    もし 「仮払精算」メニューを選択する
    かつ 仮払申請「大阪出張」を選択する
    かつ 以下の実費を登録する:
      | 日付 | 種別 | 金額 | 備考 |
      | 2024/07/20 | 交通費 | 28,500 | 新幹線代 |
      | 2024/07/20 | 宿泊費 | 12,000 | ホテル代 |
      | 2024/07/21 | 会議費 | 5,500 | 夕食会 |
      | 2024/07/21 | 宿泊費 | 12,000 | ホテル代 |
      | 2024/07/22 | 交通費 | 28,500 | 新幹線代 |
    かつ 領収書をアップロードする
    かつ 「精算」ボタンをクリックする
    ならば 精算金額が以下のように計算される:
      | 項目 | 金額 |
      | 仮払金 | 80,000 |
      | 実費合計 | 86,500 |
      | 追加支払 | 6,500 |
    かつ 追加支払分の承認申請が作成される

  シナリオ: 月次経費精算バッチ
    前提 経理花子としてログインしている
    かつ 本日は2024/07/31である
    もし 「月次精算」メニューを選択する
    かつ 対象月として「2024年7月」を選択する
    ならば 以下の精算対象が表示される:
      | 社員名 | 承認済件数 | 精算額 | ステータス |
      | 山田太郎 | 15 | 125,000 | 未処理 |
      | 鈴木一郎 | 8 | 85,000 | 未処理 |
      | 田中部長 | 12 | 230,000 | 未処理 |
    もし 「精算実行」ボタンをクリックする
    かつ 精算日を「2024/08/10」に設定する
    かつ 「実行」ボタンをクリックする
    ならば 月次精算バッチが実行される
    かつ 振込データが生成される
    かつ 仕訳データが作成される:
      """
      借方：旅費交通費 150,000 / 貸方：未払金 150,000
      借方：会議費 85,000 / 貸方：未払金 85,000
      借方：接待交際費 205,000 / 貸方：未払金 205,000
      """
    かつ 各社員に精算予定通知が送信される

  シナリオ: 経費規定違反の検出
    前提 山田太郎としてログインしている
    かつ 会社規定で「タクシー利用は23時以降のみ」と定められている
    もし 以下の経費を申請する:
      | 項目 | 値 |
      | 日付 | 2024/07/15 20:00 |
      | 種別 | 交通費 |
      | 金額 | 3,500 |
      | 内容 | タクシー代（新宿→渋谷） |
    かつ 「申請」ボタンをクリックする
    ならば 規定違反の警告が表示される:
      """
      【警告】経費規定違反の可能性
      タクシー利用は23時以降に限定されています。
      利用時刻：20:00
      
      このまま申請しますか？
      ※承認者への説明が必要です。
      """
    もし 「理由を入力して申請」を選択する
    かつ 理由として「終電に間に合わない重要顧客との会食のため」を入力する
    ならば 申請が受理される
    かつ 承認者に規定違反フラグ付きで通知される

  シナリオ: 経費予算との連動
    前提 営業部の月間交際費予算が500,000円に設定されている
    かつ 今月の交際費実績が450,000円である
    かつ 山田太郎としてログインしている
    もし 金額60,000円の接待交際費を申請する
    ならば 予算超過の警告が表示される:
      """
      【予算警告】
      営業部の交際費予算を超過します
      今月予算：500,000円
      使用済み：450,000円
      申請額：60,000円
      超過額：10,000円
      """
    かつ 「予算超過承認」のチェックボックスが表示される
    もし 予算超過を承認して申請する
    ならば 通常の承認ルートに加えて予算管理者の承認が必要となる