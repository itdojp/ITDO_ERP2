# 認証・認可システム 受け入れ条件

## 概要
本文書は、認証・認可システムの受け入れ条件とエッジケースを定義します。

## 受け入れ条件

### 1. 基本認証機能

#### メール/パスワード認証
- ✅ 有効なメールアドレスとパスワードでログインできること
- ✅ 無効な認証情報でエラーメッセージが表示されること
- ✅ パスワードは8文字以上、大文字・小文字・数字・特殊文字から3種類以上を含むこと
- ✅ ログイン成功後、JWTトークンが発行されること
- ✅ トークンの有効期限がデフォルト8時間であること

#### Google SSO
- ✅ Googleアカウントでログインできること
- ✅ 初回ログイン時に必要な情報が自動的に取得されること
- ✅ OAuth2.0フローが正しく実装されていること

### 2. 多要素認証（MFA）

#### TOTP認証
- ✅ Google Authenticatorで生成された6桁コードで認証できること
- ✅ コードの有効期限（30秒）が正しく機能すること
- ✅ 誤ったコードでエラーメッセージが表示されること
- ✅ バックアップコードが10個生成されること
- ✅ バックアップコードが1回のみ使用可能であること

#### 条件付きMFA
- ✅ 社内ネットワークからのアクセスではMFAがスキップ可能であること
- ✅ 社外からの新規ログインでMFAが必須であること
- ✅ 既知のデバイスからのアクセスでMFAがスキップ可能であること

### 3. セッション管理

#### セッションタイムアウト
- ✅ デフォルトセッション時間が8時間であること
- ✅ ユーザーが1時間〜24時間の範囲で設定変更できること
- ✅ アイドルタイムアウト（30分）が機能すること
- ✅ セッション終了時に適切にクリーンアップされること

#### セッション監視
- ✅ 管理者が全アクティブセッションを確認できること
- ✅ 各セッションの詳細情報が表示されること
- ✅ 管理者が特定のセッションを強制終了できること
- ✅ 同一ユーザーの同時セッション数が3つまでに制限されること

### 4. ユーザー管理

#### ユーザー登録・編集
- ✅ 管理者が新規ユーザーを登録できること
- ✅ メールアドレスの重複チェックが機能すること
- ✅ ユーザー情報（名前、部門、役職）を編集できること
- ✅ ユーザーを無効化（論理削除）できること

#### パスワードリセット
- ✅ リセットリンクが有効期限（1時間）内のみ有効であること
- ✅ リセットリンクが1回のみ使用可能であること
- ✅ 新パスワードがポリシーに準拠していること
- ✅ 過去5回のパスワードと重複しないこと

## エッジケース

### 認証関連

1. **同時ログイン試行**
   - 同一アカウントで複数ブラウザから同時ログイン
   - 期待動作: 3セッションまで許可、4つ目は最古のセッションを終了

2. **トークン期限切れ直前の操作**
   - アクセストークン期限切れ1秒前にAPIコール
   - 期待動作: リフレッシュトークンで自動更新

3. **ネットワーク境界でのMFA判定**
   - VPN接続/切断のタイミングでのログイン
   - 期待動作: ログイン開始時のIPアドレスで判定

### MFA関連

4. **時刻同期のずれ**
   - クライアントとサーバーの時刻が±30秒ずれている
   - 期待動作: 前後1つのウィンドウも許容（計90秒）

5. **バックアップコード枯渇**
   - 10個すべて使用済みの状態
   - 期待動作: 管理者に再発行を依頼するメッセージ表示

6. **MFAデバイス紛失**
   - Google Authenticatorをインストールした端末を紛失
   - 期待動作: バックアップコードまたは管理者経由でリセット

### セッション関連

7. **ブラウザクラッシュ**
   - セッション中にブラウザが異常終了
   - 期待動作: 再起動後もトークンが有効なら継続可能

8. **タイムゾーン変更**
   - セッション中にユーザーが別タイムゾーンに移動
   - 期待動作: UTCベースで管理するため影響なし

9. **大量セッション**
   - 1000人が同時にアクティブセッション
   - 期待動作: 3秒以内に一覧表示（ページネーション付き）

### パスワード関連

10. **連続パスワード変更**
    - 短時間に何度もパスワード変更を試みる
    - 期待動作: 24時間に3回まで制限

11. **特殊文字の扱い**
    - パスワードに絵文字や制御文字を含む
    - 期待動作: ASCII印字可能文字のみ許可

12. **SQLインジェクション試行**
    - パスワード欄に「' OR '1'='1」を入力
    - 期待動作: エスケープ処理され通常の認証失敗

### システム境界

13. **Keycloak停止**
    - 認証中にKeycloakが停止
    - 期待動作: エラーメッセージとリトライ案内

14. **Redis接続切断**
    - セッション情報取得中にRedis接続断
    - 期待動作: 再接続試行、失敗時は再ログイン要求

15. **メール送信失敗**
    - パスワードリセットメールの送信失敗
    - 期待動作: リトライ後、管理者への通知

## パフォーマンス要件

- ログイン処理: 3秒以内（MFA含む）
- トークン検証: 50ms以内
- セッション一覧表示: 1000件で3秒以内
- 同時認証処理: 100リクエスト/秒

## セキュリティ要件

- すべての通信はTLS 1.3以上
- パスワードはbcrypt（cost factor 12）でハッシュ化
- JWTはRS256で署名
- 監査ログの90日間保持
- OWASP Top 10準拠