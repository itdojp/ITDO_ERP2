# 認証・認可システム フィーチャーブリーフ

## ビジネス目的
ITDO ERPシステムへの安全なアクセス制御を実現し、企業の機密情報を保護しながら、ユーザーの利便性を確保する。社内外からの安全なアクセスを可能にし、組織のセキュリティポリシーに準拠する。

## 主要ユーザー
- **システム管理者**: 全社的なユーザー管理、セキュリティ設定
- **部門管理者**: 部門内のユーザー管理、権限設定
- **一般ユーザー**: 日常業務でのシステム利用
- **外部ユーザー**: 取引先等、限定的なアクセス権限を持つユーザー

## 優先実装機能

### Phase 1（必須）
1. **基本認証機能**
   - メール/パスワードによる認証
   - GoogleアカウントによるSSO（OAuth2.0）
   - JWTトークンによるセッション管理

2. **多要素認証（MFA）**
   - Google Authenticator等によるTOTP認証
   - 社外からの新規ログイン時は必須
   - バックアップコード（10個）の提供

3. **セッション管理**
   - デフォルト8時間のセッションタイムアウト
   - ユーザーによるセッション時間の個別設定（1時間〜24時間）
   - 管理者によるユーザーセッション状況の確認
   - アイドルタイムアウト（30分）

4. **ユーザー管理**
   - 管理者によるユーザー登録・編集・無効化
   - ユーザープロフィール編集
   - パスワードリセット（メール経由）

### Phase 2（推奨）
5. **高度な権限管理**
   - RBAC（ロールベースアクセス制御）
   - カスタムロールの作成
   - 部門別データアクセス制御

6. **その他のSSO対応**
   - SAML2.0対応（将来の企業連携用）
   - Microsoft Entra ID連携

## 主要なユースケース

### 社内からのアクセス
1. ユーザーがメール/パスワードまたはGoogleアカウントでログイン
2. IPアドレスが社内ネットワークの場合、MFAはスキップ可能
3. セッション時間をユーザーが選択（デフォルト8時間）
4. 業務アプリケーションへアクセス

### 社外からのアクセス
1. ユーザーがメール/パスワードまたはGoogleアカウントでログイン
2. 新規ログインの場合、Google Authenticatorで生成されたOTPを入力（必須）
3. 既知のデバイスからの場合、デバイス記憶により次回からMFAスキップ可能
4. セッション時間を短めに設定することを推奨

### 管理者による監視
1. 管理者がユーザーセッション一覧を確認
2. 各ユーザーの現在のセッション状態、設定時間、最終アクセス時刻を表示
3. 必要に応じて特定セッションを強制終了

## 技術要件
- **認証基盤**: Keycloakによる統一認証
- **プロトコル**: OAuth2.0 / OpenID Connect
- **トークン**: JWT（RS256署名）
- **セッション保存**: Redis（クラスター構成）
- **MFA**: TOTP（RFC 6238準拠）

## セキュリティ要件
- **パスワードポリシー**: 
  - 8文字以上
  - 大文字・小文字・数字・特殊文字から3種類以上
  - 過去5回のパスワード再利用禁止
- **アカウントロック**: 5回連続ログイン失敗で30分ロック
- **監査ログ**: すべての認証イベントを記録
- **通信**: TLS 1.3必須

## 制約事項
- Keycloakとの統合が必須
- 既存のGoogle Workspace組織との連携
- GDPR/個人情報保護法準拠
- 同時セッション数は1ユーザーあたり3まで

## 成功基準
- 100人規模の組織で安定動作
- ログイン応答時間3秒以内（MFA含む）
- 99.9%の可用性
- セキュリティ監査（OWASP Top 10）をパス
- ユーザビリティテストで満足度80%以上

## 段階的リリース計画
1. **MVP（2週間）**: 基本認証 + Google SSO + セッション管理
2. **Phase 1（1ヶ月）**: MFA + ユーザー管理 + セッション設定
3. **Phase 2（2ヶ月）**: RBAC + 他SSO対応