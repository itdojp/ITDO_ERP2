# Claude Code 使用ガイド

## 概要

このガイドでは、ITDO ERP System v2プロジェクトでClaude Codeを使用する際の正しい方法について説明します。

## プロジェクト設定ファイル

Claude Codeは以下の設定ファイルを参照して開発を行います：

### メイン設定ファイル
- **CLAUDE.md** - Claude Code用のメイン設定とプロジェクト概要

### 詳細設定ファイル（.claudeディレクトリ）
- **.claude/PROJECT_CONTEXT.md** - プロジェクトコンテキストとビジネスドメイン知識
- **.claude/DEVELOPMENT_WORKFLOW.md** - 詳細な開発ワークフローとプロセス
- **.claude/CODING_STANDARDS.md** - コーディング規約と品質要件
- **.claude/TECHNICAL_CONSTRAINTS.md** - 技術的制約と制限事項

## Claude Code起動時のプロンプト

### パターン1: 直接的な指示（簡潔版）
```
CLAUDE.mdファイルを読み込んで、そこに記載された開発ルールと制約に従って開発を進めてください。
```

### パターン2: 詳細な指示
```
まず最初にCLAUDE.mdファイルを読み込み、そこに記載されている「Required Reading Files」セクションの4つのファイルもすべて読み込んでください。その後、記載されている開発プロセスと制約事項に厳密に従って開発作業を行ってください。
```

### パターン3: 具体的なタスクと組み合わせ
```
CLAUDE.mdファイルとそこで参照されているすべての設定ファイルを読み込んでから、Issue #[番号] の [機能名] の実装を8段階の開発プロセスに従って行ってください。
```

### パターン4: 最も確実な方法（推奨）
```
以下の手順で開発を進めてください：

1. CLAUDE.mdファイルを読み込む
2. CLAUDE.mdの「Required Reading Files」に記載された以下の4つのファイルを読み込む：
   - .claude/PROJECT_CONTEXT.md
   - .claude/DEVELOPMENT_WORKFLOW.md
   - .claude/CODING_STANDARDS.md
   - .claude/TECHNICAL_CONSTRAINTS.md
3. これらのファイルに記載されたルール、制約、プロセスに従って Issue #[番号] の実装を行う

特に以下を厳守してください：
- TDD（テスト駆動開発）
- 8段階の開発プロセス
- 型安全性（any型禁止）
- ハイブリッド開発環境の使用
```

## 実際の使用例

### Issue実装時の完全なプロンプト例

Issue #123の「ユーザー管理機能」を実装する場合：

```
以下の手順で開発を進めてください：

1. CLAUDE.mdファイルを読み込む
2. CLAUDE.mdの「Required Reading Files」に記載された4つの設定ファイルをすべて読み込む
3. これらの設定に従って Issue #123 の「ユーザー管理機能」を実装する

必須事項：
- 8段階の開発プロセスに従う
- テストコードを先に実装（TDD）
- 型安全性を確保
- ハイブリッド開発環境を使用

実装対象：
- ユーザーCRUD操作のAPI
- フロントエンドのユーザー管理画面
- 認証・認可の統合
```

### 短縮版（慣れてきた場合）

```
CLAUDE.mdの設定に従って Issue #[番号] の [機能名] を実装してください。
```

## 開発プロセス

Claude Codeは以下の8段階プロセスに従って開発を行います：

1. **Issue確認フェーズ** - 要件の理解と関連Issue/PRの確認
2. **Draft PR作成フェーズ** - ブランチ作成とDraft PR作成
3. **仕様書作成フェーズ** - 詳細仕様書の作成
4. **テスト仕様作成フェーズ** - テストケースの定義
5. **テストコード実装フェーズ** - テストファーストでの実装
6. **実装フェーズ** - プロダクションコードの実装
7. **ドキュメント更新フェーズ** - 関連ドキュメントの更新
8. **レビュー準備フェーズ** - セルフレビューとPR準備

## 重要な制約事項

### 必須制約
- **TDD（テスト駆動開発）**: テストコードを先に実装
- **Issue起点開発**: すべての作業はGitHub Issueから開始
- **型安全性**: any型の使用禁止、strict型チェック必須
- **ハイブリッド環境**: データ層はコンテナ、開発層はローカル推奨
- **uvツール使用**: Python環境管理（pip/activate使用禁止）

### 品質基準
- API応答時間: 200ms以内
- テストカバレッジ: 80%以上
- 同時接続数: 1000ユーザー対応
- エラーハンドリング: すべての関数で必須実装

## 開発環境コマンド

### データ層起動（必須）
```bash
podman-compose -f infra/compose-data.yaml up -d
```

### ローカル開発（推奨）
```bash
# Backend
cd backend && uv run uvicorn app.main:app --reload

# Frontend（別ターミナル）
cd frontend && npm run dev
```

### テスト実行
```bash
# Backend
cd backend && uv run pytest

# Frontend
cd frontend && npm test
```

### 型チェック
```bash
# Backend
cd backend && uv run mypy --strict .

# Frontend
cd frontend && npm run typecheck
```

## トラブルシューティング

### Claude Codeが設定ファイルを読み込まない場合

1. **明示的にファイル名を指定**
   ```
   .claude/DEVELOPMENT_WORKFLOW.mdファイルの内容を確認してから実装してください。
   ```

2. **ファイル存在確認**
   ```bash
   ls -la CLAUDE.md .claude/
   ```

3. **手動でファイル内容をプロンプトに含める**
   設定ファイルの重要な部分を直接プロンプトに記載する

### 開発プロセスが守られない場合

1. **段階的な指示**
   各フェーズを個別に指示する

2. **制約事項の再確認**
   TDDや型安全性などの制約を明示的に指示

3. **品質チェック**
   実装後に品質基準を満たしているか確認

## ベストプラクティス

### 初回使用時
- **パターン4**（最も確実な方法）を使用
- 設定ファイルが正しく読み込まれているか確認
- 8段階プロセスが守られているか確認

### 日常使用時
- 慣れてきたら**短縮版**プロンプトを使用
- 定期的に設定ファイルの更新を確認
- チーム内でプロンプトパターンを統一

### チーム開発時
- プロンプトテンプレートを標準化
- 設定ファイルの変更履歴を共有
- コードレビュー時に設定遵守を確認

## 小タスク管理戦略（DART Framework）

### DART (Dynamic Agent Response Tuning) v3.1

2025-07-12の実験結果に基づく、エージェント特性に応じた動的タスク管理フレームワーク。

#### DART v3.1の特徴
- **プロアクティブサポート**: 問題発生前の先回りサポート
- **30分間隔フォローアップ**: 積極的な進捗確認
- **個別最適化**: エージェント特性に応じた支援方法

#### エージェントタイプ分類

1. **継続型エージェント**
   - 特徴: 大規模作業への深い集中力、技術的専門性が高い
   - 最適: PR修正、複雑な技術問題解決
   - 例: CC01タイプ

2. **並行型エージェント**
   - 特徴: 複数タスクの同時処理能力、コンテキストスイッチが得意
   - 最適: 小タスク群、ドキュメント更新
   - 例: CC02タイプ

3. **開拓型エージェント**
   - 特徴: 新規タスクへの積極性、自己組織化能力
   - 最適: 新機能開発、探索的タスク
   - 例: CC03タイプ

### タスク投入アプローチ

#### 段階的アプローチ（継続型向け）
**適用場面**: 高品質・慎重な実装が必要な場合
```
1. メインタスクに集中させる
2. 完了後に次のタスクを提示
3. 技術的な詳細サポートを提供
- 集中的取り組みによる高品質な成果
- 慎重な検討プロセス
- 技術的複雑さへの対応
```

#### 並行アプローチ（並行型向け）
**適用場面**: 効率性・自律性を重視する場合
```
1. 複数の小タスクを同時提示
2. 優先順位を明確に示す
3. 進捗を定期的に確認
- 選択の自由による自律性向上
- エージェントの得意分野活用
- 柔軟性のあるワークフロー
```

#### 効果的なタスク特性

**高効果タスク**
- 明確な完了条件
- 15-30分で完了可能
- 技術的に独立
- 即座にテスト可能

**要注意タスク**
- 他タスクへの依存が高い
- 仕様が曖昧
- 大規模リファクタリング
- 外部サービス連携

### 実験結果に基づくベストプラクティス

#### エージェント特性の観察結果
- **慎重性**: 技術タスクは即座の反応ではなく、適切な検討時間が必要
- **複雑性の影響**: 提示方法に関わらず、技術的複雑さが検討時間に影響
- **コミュニケーション**: リアルタイム観察による微細な行動パターン把握が重要

#### 効果的なタスク投入タイミング
1. **初期反応時間**: 9-15分の検討時間を考慮
2. **フォローアップ間隔**: 30分ごとの進捗確認
3. **技術的複雑さ**: 複雑なタスクほど段階的アプローチが有効

#### 成功パターン（Issue #125実験結果）
1. **Issue #127（mypy警告修正）**: 15分で完了
   - 明確な技術仕様
   - 独立性が高い
   - 即座に検証可能

2. **継続型への最適化**
   - ストレス軽減による品質向上
   - 技術的深堀りの時間確保
   - 自然な作業リズムの尊重

#### 学習事項
- エージェントの自己申告を尊重
- 過度なマルチタスクは逆効果
- 技術的サポートの重要性
- 完了報告の迅速性が信頼指標

### プロアクティブサポート戦略

#### 問題発生前の支援
- **技術的障壁の早期特定**: 実装前の環境・依存関係チェック
- **詳細手順の事前提供**: ステップバイステップのガイダンス
- **リアルタイム監視**: 進捗状況の継続的な把握

#### エージェント特性に応じた対応
- **学習スタイル考慮**: 段階的 vs 包括的な説明
- **ペース尊重**: 個々のエージェントの作業ペースに合わせた支援
- **得意分野活用**: バックエンド、フロントエンド、インフラの専門性を活かした役割分担

## マルチエージェント協働 (2025年7月追加)

### エージェント識別と役割分担

#### 環境変数による識別
```bash
# 各エージェントの識別
CLAUDE_AGENT_ID=CC01  # Backend specialist
CLAUDE_AGENT_ID=CC02  # Full-stack developer  
CLAUDE_AGENT_ID=CC03  # Infrastructure specialist
AGENT_LABEL=cc01      # GitHub Issue label
```

#### 専門分野に基づく役割分担
- **CC01**: バックエンド開発、データベース設計、API実装
- **CC02**: フルスタック開発、統合テスト、品質保証
- **CC03**: インフラ、CI/CD、デプロイメント、システム運用

### 協働プロトコル

#### Issue処理の優先順位
1. **緊急Issue**: emergency, critical ラベル → 即座対応
2. **高優先度Issue**: high priority → 24時間以内
3. **通常Issue**: 数値順での順次処理

#### 継続監視体制
- **24/7稼働**: 各エージェントが継続的にIssue監視
- **相互バックアップ**: 他エージェント不在時の代替対応
- **技術的支援**: 専門分野での相互サポート

## 最新のベストプラクティス (2025年7月)

### エージェント開始時の推奨プロンプト
```
割り当てられた作業を確認して順番に規定に沿って処理を行い、規定に沿って結果を報告してください。
```

### 継続作業パターン
1. **Issue確認**: `gh issue list --label "cc01" --state open`
2. **順次処理**: Issue番号順での体系的処理
3. **完了報告**: 各Issue完了時の詳細報告
4. **継続監視**: 新規Issue出現時の即座対応

### 緊急対応プロトコル
- **応答時間**: 緊急Issue発生から5分以内
- **エスカレーション**: 30分無応答でLevel 1エスカレーション
- **代替体制**: 人間開発者バックアップとの連携

## 更新履歴

- 2025-07-13: DART Framework v3.1 追加
  - 小タスク管理戦略セクション新設
  - 実験結果と学習事項の反映
  - DARTフレームワークv3.1の説明
  - 段階的 vs 並行アプローチの実験結果
  - マルチエージェント協働プロトコル
  - プロアクティブサポート戦略
  - 最新のベストプラクティス更新
- 2025-07-04: 初版作成
  - プロンプトパターンの定義
  - 使用例とベストプラクティスの追加
