# Claude Code エージェント トラブルシューティングガイド

## 🔍 2025年7月11日の実績分析

### 📊 エージェント応答率
- **CC01**: ✅ 応答率 100%（1行修正を30秒で完了）
- **CC02**: ❌ 応答率 0%（9回の指示に無反応）
- **CC03**: ❌ 応答率 0%（9回の指示に無反応）
- **全体**: 33%の応答率（3エージェント中1）

## 🚨 発見された問題と解決策

### 1. 自動化システムの起動問題

#### 問題
- バックグラウンドプロセスが起動していない
- `my-tasks`コマンドが動作しない
- 15分ポーリングが機能していない

#### 根本原因
- Claude Codeセッション間での環境変数の非永続性
- バックグラウンドプロセスの予期しない終了
- 初期化スクリプトの未実行

#### 解決策
```bash
# セッション開始時に必ず実行
source scripts/claude-code-automation/agent/agent-init.sh CC01  # エージェントIDに合わせて

# 成功確認（必須）
echo $CLAUDE_AGENT_ID  # エージェントIDが表示されるか
ps aux | grep "sleep 900"  # ポーリングプロセスが動作中か
```

### 2. タスク取得の失敗

#### 問題
- `my-tasks`エイリアスが未定義
- GitHub CLIの認証エラー
- ラベルフィルタリングの不一致

#### 解決策
```bash
# 手動でのタスク確認（確実な方法）
gh issue list --label "cc01" --state open  # エージェントIDに合わせて

# 詳細なタスク情報取得
gh issue view [ISSUE_NUMBER] --comments
```

### 3. エージェント間の通信問題

#### 問題
- Issue #99での自動報告が機能しない
- エージェント間の情報共有不足
- 重複作業や作業の抜け漏れ

#### 解決策
- 明示的なIssueコメントでの指示
- 定期的な手動状況確認
- 共通Issue（#104, #107）での情報集約

## 🎯 効果的だった方法

### ✅ 成功パターン

#### 1. 具体的なコマンド指示
```bash
# 良い例：1行修正の明確な指示
git checkout feature/task-department-integration-CRITICAL
sed -i '46s/.*//' backend/tests/conftest.py
git add backend/tests/conftest.py
git commit -m "fix: Remove whitespace from empty line in conftest.py"
git push origin feature/task-department-integration-CRITICAL
```
**結果**: CC01が30秒で実行完了

#### 2. 緊急性の明確な表現
- 🚨マークの使用
- "CRITICAL"、"URGENT"の明記
- 具体的な期限の設定

#### 3. 代替手段の提供
```bash
# プライマリ手段
my-tasks

# 代替手段
gh issue list --label "cc01" --state open
```

### ❌ 失敗パターン

#### 1. 自動化への過度な依存
- バックグラウンドプロセスの前提
- 環境変数の永続性の期待
- ポーリングメカニズムへの依存

#### 2. 暗黙的な指示
- "適切に対応してください"
- "自動化システムを使用してください"
- 具体的なコマンドなしの指示

## 📋 推奨トラブルシューティング手順

### セッション開始時チェックリスト

1. **環境確認**
   ```bash
   pwd  # /mnt/c/work/ITDO_ERP2
   git status  # クリーンな状態か
   gh auth status  # 認証状態
   ```

2. **エージェントID設定**
   ```bash
   export CLAUDE_AGENT_ID=CC01  # 手動設定
   echo $CLAUDE_AGENT_ID  # 確認
   ```

3. **タスク確認**
   ```bash
   gh issue list --label "cc01" --state open
   gh issue view 99 --comments | tail -10  # 最新状況
   ```

### 問題発生時の対処

1. **応答がない場合**
   - 直接的なIssueコメント送信
   - 具体的なコマンド列挙
   - 成功確認方法の明示

2. **エラー発生時**
   - エラーメッセージの共有要請
   - 代替コマンドの提供
   - 手動実行手順の説明

3. **進捗が遅い場合**
   - 技術的サポートの提供
   - 他エージェントへのタスク移譲
   - 部分的な解決策の検討

## 🔧 システム改善提案

### 短期的改善

1. **明示的な初期化**
   - セッション開始時の必須手順化
   - 成功確認の義務化
   - エラー時の対処明文化

2. **手動フォールバック強化**
   - 自動化失敗時の手順整備
   - 基本的なghコマンド集
   - トラブルシューティングフロー

### 長期的改善

1. **監視機能の追加**
   - エージェント稼働状況ダッシュボード
   - 自動アラート機能
   - 応答時間の追跡

2. **信頼性の向上**
   - セッション間での状態保持
   - プロセス自動復旧
   - エラーハンドリング強化

## 📈 メトリクスと改善目標

### 現状（2025年7月11日）
- 応答率: 33%
- 平均応答時間: CC01のみ30秒
- タスク完了率: 95%（Phase 3）

### 改善目標
- 応答率: 90%以上
- 平均応答時間: 5分以内
- タスク完了率: 100%

## 🎓 学習事項のまとめ

### 技術的教訓
1. **シンプルが最強**: 複雑な自動化より明確な指示
2. **冗長性の重要性**: 複数の実行方法を常に用意
3. **確認の必要性**: 実行結果の明示的な確認

### プロジェクト管理の教訓
1. **単一障害点の回避**: 複数エージェントへの分散
2. **進捗の可視化**: 定期的な状況報告
3. **優先順位の明確化**: CRITICALタスクへの集中

---

**重要**: このガイドは実際の運用経験に基づいています。新しい問題や解決策が見つかった場合は、随時更新してください。

**更新履歴**:
- 2025-07-11: 初版作成（Phase 3の経験を基に）