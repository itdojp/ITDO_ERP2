name: Type Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # å³æ ¼ãªå‹ãƒã‚§ãƒƒã‚¯å°‚ç”¨ã‚¸ãƒ§ãƒ–
  strict-typecheck:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Python å³æ ¼å‹ãƒã‚§ãƒƒã‚¯
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        enable-cache: true
    
    - name: Set up Python
      run: uv python install 3.13
    
    - name: Install Python dependencies
      run: |
        cd backend
        uv sync --dev
    
    - name: Run mypy strict type checking
      run: |
        cd backend
        uv run mypy --strict --show-error-codes --show-column-numbers app/
    
    - name: Check for excessive any type usage
      run: |
        cd backend
        # Anyå‹ã®ä½¿ç”¨å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå‹æ³¨é‡ˆã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã®ã¿ï¼‰
        ANY_COUNT=$(grep -r ": Any" app/ --include="*.py" | grep -v "# type: ignore" | wc -l)
        echo "ğŸ“Š Anyå‹ã®ä½¿ç”¨: ${ANY_COUNT}ç®‡æ‰€"
        
        # è©³ç´°ã‚’è¡¨ç¤º
        echo ""
        echo "### Anyå‹ä½¿ç”¨ç®‡æ‰€ã®è©³ç´°:"
        grep -r ": Any" app/ --include="*.py" | grep -v "# type: ignore" || true
        echo ""
        
        # é–¾å€¤ã‚’è¨­å®šï¼ˆ30ç®‡æ‰€ä»¥ä¸‹ï¼‰
        if [ $ANY_COUNT -gt 30 ]; then
          echo "âš ï¸ Anyå‹ã®ä½¿ç”¨ãŒå¤šã™ãã¾ã™ï¼ˆ${ANY_COUNT}ç®‡æ‰€ï¼‰ã€‚å¯èƒ½ãªé™ã‚Šå…·ä½“çš„ãªå‹ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"
          echo "ç¾åœ¨ã®é–¾å€¤: 30ç®‡æ‰€"
          exit 1
        else
          echo "âœ… Anyå‹ã®ä½¿ç”¨ã¯è¨±å®¹ç¯„å›²å†…ã§ã™ï¼ˆé–¾å€¤: 30ç®‡æ‰€ï¼‰"
        fi
    
    # TypeScript å³æ ¼å‹ãƒã‚§ãƒƒã‚¯
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Node.js dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run TypeScript strict type checking
      run: |
        cd frontend
        npx tsc --noEmit --strict
    
    - name: Check for any type usage in TypeScript
      run: |
        cd frontend
        # anyå‹ã®ä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯
        if grep -r ": any\|<any>" src/ --include="*.ts" --include="*.tsx" | grep -v "// @ts-ignore" | grep -v "// eslint-disable"; then
          echo "âŒ anyå‹ã®ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚å‹ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"
          exit 1
        else
          echo "âœ… anyå‹ã®ä½¿ç”¨ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"
        fi
    
    - name: Check for unused exports (TypeScript)
      run: |
        cd frontend
        npx ts-unused-exports tsconfig.json --maxIssues=0
    
    - name: Advanced TypeScript checks
      run: |
        cd frontend
        # strictNullChecksã®ç¢ºèª
        npx tsc --noEmit --strictNullChecks
        
        # noImplicitReturnsã®ç¢ºèª
        npx tsc --noEmit --noImplicitReturns
        
        # noImplicitAnyã®ç¢ºèª
        npx tsc --noEmit --noImplicitAny

  # å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
  type-coverage:
    runs-on: ubuntu-latest
    needs: strict-typecheck
    
    steps:
    - uses: actions/checkout@v4
    
    # Pythonå‹ã‚«ãƒãƒ¬ãƒƒã‚¸
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        enable-cache: true
    
    - name: Set up Python
      run: uv python install 3.13
    
    - name: Install Python dependencies
      run: |
        cd backend
        uv sync --dev
        uv add --dev type-coverage
    
    - name: Generate Python type coverage report
      run: |
        cd backend
        uv run python -m type_coverage.main app/ --json > type-coverage-python.json
        uv run python -m type_coverage.main app/ > type-coverage-python.txt
    
    # TypeScriptå‹ã‚«ãƒãƒ¬ãƒƒã‚¸
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Node.js dependencies
      run: |
        cd frontend
        npm ci
        npm install -g typescript-coverage-report
    
    - name: Generate TypeScript type coverage report
      run: |
        cd frontend
        typescript-coverage-report --threshold 95 --outputDir type-coverage-report
    
    - name: Upload type coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: type-coverage-reports
        path: |
          backend/type-coverage-python.json
          backend/type-coverage-python.txt
          frontend/type-coverage-report/
    
    - name: Comment type coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const prNumber = context.payload.pull_request.number;
          
          let comment = `ğŸ“Š **å‹ãƒã‚§ãƒƒã‚¯çµæœ**\n\n`;
          
          try {
            // Pythonå‹ã‚«ãƒãƒ¬ãƒƒã‚¸ã®èª­ã¿è¾¼ã¿
            const pythonCoverage = fs.readFileSync('backend/type-coverage-python.txt', 'utf8');
            const pythonMatch = pythonCoverage.match(/Type coverage: ([\d.]+)%/);
            const pythonPercent = pythonMatch ? pythonMatch[1] : 'N/A';
            
            comment += `| é …ç›® | çµæœ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |\n`;
            comment += `|------|------|----------|\n`;
            comment += `| Python å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ | ${pythonPercent}% | ${parseFloat(pythonPercent) >= 95 ? 'âœ…' : 'âš ï¸'} |\n`;
            comment += `| TypeScript å³æ ¼ãƒã‚§ãƒƒã‚¯ | å®Œäº† | âœ… |\n`;
            comment += `| anyå‹ä½¿ç”¨ãƒã‚§ãƒƒã‚¯ | å®Œäº† | âœ… |\n`;
            comment += `| æœªä½¿ç”¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | å®Œäº† | âœ… |\n\n`;
            
            if (parseFloat(pythonPercent) < 95) {
              comment += `âš ï¸ **æ³¨æ„**: Pythonå‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ95%ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ã€‚å‹æ³¨é‡ˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚\n\n`;
            }
            
          } catch (error) {
            comment += `âŒ å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}\n\n`;
          }
          
          comment += `è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯ Artifacts ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚\n`;
          comment += `\n---\n`;
          comment += `*ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });

  # å‹ãƒã‚§ãƒƒã‚¯å“è³ªã‚²ãƒ¼ãƒˆ
  typecheck-quality-gate:
    runs-on: ubuntu-latest
    needs: [strict-typecheck, type-coverage]
    if: always()
    
    steps:
    - name: Check type check results
      run: |
        if [[ "${{ needs.strict-typecheck.result }}" != "success" ]]; then
          echo "âŒ å³æ ¼å‹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi
        
        if [[ "${{ needs.type-coverage.result }}" != "success" ]]; then
          echo "âš ï¸ å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          # å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯è­¦å‘Šã®ã¿ã§æ­¢ã‚ãªã„
        fi
        
        echo "âœ… å‹ãƒã‚§ãƒƒã‚¯å“è³ªã‚²ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸ"