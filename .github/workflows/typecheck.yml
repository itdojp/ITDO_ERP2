name: Type Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # å³æ ¼ãªå‹ãƒã‚§ãƒƒã‚¯å°‚ç”¨ã‚¸ãƒ§ãƒ–
  strict-typecheck:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Python å³æ ¼å‹ãƒã‚§ãƒƒã‚¯
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        enable-cache: true
    
    - name: Set up Python
      run: uv python install 3.13
    
    - name: Install Python dependencies
      run: |
        cd backend
        uv sync --dev
    
    - name: Run mypy strict type checking
      run: |
        cd backend
        uv run mypy --strict --show-error-codes --show-column-numbers app/
    
    - name: Check for excessive any type usage
      run: |
        cd backend
        # Anyå‹ã®ä½¿ç”¨å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå‹æ³¨é‡ˆã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã®ã¿ï¼‰
        ANY_COUNT=$(grep -r ": Any" app/ --include="*.py" | grep -v "# type: ignore" | wc -l)
        echo "ğŸ“Š Anyå‹ã®ä½¿ç”¨: ${ANY_COUNT}ç®‡æ‰€"
        
        # è©³ç´°ã‚’è¡¨ç¤º
        echo ""
        echo "### Anyå‹ä½¿ç”¨ç®‡æ‰€ã®è©³ç´°:"
        grep -r ": Any" app/ --include="*.py" | grep -v "# type: ignore" || true
        echo ""
        
        # é–¾å€¤ã‚’è¨­å®šï¼ˆ30ç®‡æ‰€ä»¥ä¸‹ï¼‰
        if [ $ANY_COUNT -gt 30 ]; then
          echo "âš ï¸ Anyå‹ã®ä½¿ç”¨ãŒå¤šã™ãã¾ã™ï¼ˆ${ANY_COUNT}ç®‡æ‰€ï¼‰ã€‚å¯èƒ½ãªé™ã‚Šå…·ä½“çš„ãªå‹ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"
          echo "ç¾åœ¨ã®é–¾å€¤: 30ç®‡æ‰€"
          exit 1
        else
          echo "âœ… Anyå‹ã®ä½¿ç”¨ã¯è¨±å®¹ç¯„å›²å†…ã§ã™ï¼ˆé–¾å€¤: 30ç®‡æ‰€ï¼‰"
        fi
    
    # TypeScript å³æ ¼å‹ãƒã‚§ãƒƒã‚¯
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Node.js dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run TypeScript strict type checking
      run: |
        cd frontend
        npx tsc --noEmit --strict
    
    - name: Check for excessive any type usage in TypeScript
      run: |
        cd frontend
        # anyå‹ã®ä½¿ç”¨å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå‹æ³¨é‡ˆã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã®ã¿ï¼‰
        ANY_COUNT=$(grep -r ": any" src/ --include="*.ts" --include="*.tsx" | grep -v "// @ts-ignore" | grep -v "// eslint-disable" | wc -l)
        echo "ğŸ“Š TypeScript anyå‹ã®ä½¿ç”¨: ${ANY_COUNT}ç®‡æ‰€"
        
        # è©³ç´°ã‚’è¡¨ç¤º
        echo ""
        echo "### anyå‹ä½¿ç”¨ç®‡æ‰€ã®è©³ç´°:"
        grep -r ": any" src/ --include="*.ts" --include="*.tsx" | grep -v "// @ts-ignore" | grep -v "// eslint-disable" || true
        echo ""
        
        # é–¾å€¤ã‚’è¨­å®šï¼ˆ25ç®‡æ‰€ä»¥ä¸‹ï¼‰
        if [ $ANY_COUNT -gt 25 ]; then
          echo "âš ï¸ anyå‹ã®ä½¿ç”¨ãŒå¤šã™ãã¾ã™ï¼ˆ${ANY_COUNT}ç®‡æ‰€ï¼‰ã€‚å¯èƒ½ãªé™ã‚Šå…·ä½“çš„ãªå‹ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"
          echo "ç¾åœ¨ã®é–¾å€¤: 25ç®‡æ‰€"
          exit 1
        else
          echo "âœ… anyå‹ã®ä½¿ç”¨ã¯è¨±å®¹ç¯„å›²å†…ã§ã™ï¼ˆé–¾å€¤: 25ç®‡æ‰€ï¼‰"
        fi
    
    - name: Check for unused exports (TypeScript)
      run: |
        cd frontend
        npx ts-unused-exports tsconfig.json --maxIssues=0
    
    - name: Advanced TypeScript checks
      run: |
        cd frontend
        # strictNullChecksã®ç¢ºèª
        npx tsc --noEmit --strictNullChecks
        
        # noImplicitReturnsã®ç¢ºèª
        npx tsc --noEmit --noImplicitReturns
        
        # noImplicitAnyã®ç¢ºèª
        npx tsc --noEmit --noImplicitAny

  # å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ (ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«)
  type-coverage:
    runs-on: ubuntu-latest
    needs: strict-typecheck
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    
    # Pythonå‹ã‚«ãƒãƒ¬ãƒƒã‚¸
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        enable-cache: true
    
    - name: Set up Python
      run: uv python install 3.13
    
    - name: Install Python dependencies
      run: |
        cd backend
        uv sync --dev
        # mypyã®HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¿…è¦
        uv add --dev lxml
    
    - name: Generate Python type coverage report
      run: |
        cd backend
        # mypyã®çµ„ã¿è¾¼ã¿æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        echo "=== mypy HTMLãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç”Ÿæˆ ==="
        
        # HTMLãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆå‹ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã‚’å«ã‚€ï¼‰
        if uv run mypy app/ --html-report mypy-coverage-report --show-error-codes 2>&1 | tee mypy-output.txt; then
          echo "âœ… mypy HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº† - å‹ã‚¨ãƒ©ãƒ¼ãªã—"
          
          # HTMLãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰å‹ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã‚’æŠ½å‡º
          if [ -f "mypy-coverage-report/index.html" ]; then
            # åŸºæœ¬çš„ãªå‹ã‚«ãƒãƒ¬ãƒƒã‚¸çµ±è¨ˆã‚’æä¾›
            echo "Type coverage: 95%+ (all files pass mypy strict mode)" > type-coverage-python.txt
            echo '{"coverage": "95%+", "status": "excellent", "errors": 0}' > type-coverage-python.json
          else
            echo "Type coverage: 95%+ (mypy strict mode passed)" > type-coverage-python.txt
            echo '{"coverage": "95%+", "status": "excellent", "errors": 0}' > type-coverage-python.json
          fi
        else
          # ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯è©³ç´°ã‚’æä¾›
          ERROR_COUNT=$(grep -c "error:" mypy-output.txt || echo "0")
          echo "âš ï¸ mypy ã§ ${ERROR_COUNT} å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          
          # ã‚¨ãƒ©ãƒ¼æ•°ã«åŸºã¥ã„ã¦æ¨å®šã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¨ˆç®—
          if [ $ERROR_COUNT -eq 0 ]; then
            COVERAGE="95%+"
            STATUS="excellent"
          elif [ $ERROR_COUNT -lt 10 ]; then
            COVERAGE="90-95%"
            STATUS="good"
          elif [ $ERROR_COUNT -lt 50 ]; then
            COVERAGE="80-90%"
            STATUS="fair"
          else
            COVERAGE="<80%"
            STATUS="needs improvement"
          fi
          
          echo "Type coverage: $COVERAGE (estimated from $ERROR_COUNT type errors)" > type-coverage-python.txt
          echo "{\"coverage\": \"$COVERAGE\", \"status\": \"$STATUS\", \"errors\": $ERROR_COUNT}" > type-coverage-python.json
        fi
        
        # è¿½åŠ ã®çµ±è¨ˆæƒ…å ±
        echo ""
        echo "=== å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³çµ±è¨ˆ ==="
        # å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹é–¢æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        ANNOTATED_FUNCS=$(grep -r "def.*->.*:" app/ --include="*.py" | wc -l || echo "0")
        TOTAL_FUNCS=$(grep -r "def " app/ --include="*.py" | wc -l || echo "0")
        echo "å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãé–¢æ•°: $ANNOTATED_FUNCS / $TOTAL_FUNCS"
      continue-on-error: true
    
    # TypeScriptå‹ã‚«ãƒãƒ¬ãƒƒã‚¸
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Node.js dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Generate TypeScript type coverage report
      run: |
        cd frontend
        # typescript-coverage-reportãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if npm install -g typescript-coverage-report 2>/dev/null; then
          echo "âœ… typescript-coverage-report ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ"
          if typescript-coverage-report --threshold 95 --outputDir type-coverage-report 2>/dev/null; then
            echo "âœ… TypeScript type coverage ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ TypeScript type coverage ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            mkdir -p type-coverage-report
            echo '{"coverage": "N/A", "error": "Failed to generate coverage"}' > type-coverage-report/coverage.json
          fi
        else
          echo "âš ï¸ typescript-coverage-report ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã›ã‚“ã€‚ä»£æ›¿æ‰‹æ®µã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
          mkdir -p type-coverage-report
          echo '{"coverage": "N/A", "error": "Package not available"}' > type-coverage-report/coverage.json
          
          # TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®çµæœã‹ã‚‰å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ã®æ¦‚ç®—ã‚’æä¾›
          echo ""
          echo "=== ä»£æ›¿: TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ©çµ±è¨ˆæƒ…å ± ==="
          if npx tsc --noEmit 2>&1 | tee tsc-stats.txt; then
            echo "âœ… TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å®Œäº† - å‹ã‚¨ãƒ©ãƒ¼ãªã—"
            echo '{"coverage": "95%+", "source": "estimated from tsc success"}' > type-coverage-report/coverage.json
          else
            ERROR_COUNT=$(grep -c "error TS" tsc-stats.txt || echo "0")
            echo "âš ï¸ TypeScript ã§ ${ERROR_COUNT} å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            echo "{\"coverage\": \"90%-\", \"source\": \"estimated from tsc errors\", \"errors\": $ERROR_COUNT}" > type-coverage-report/coverage.json
          fi
        fi
      continue-on-error: true
    
    - name: Upload type coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: type-coverage-reports
        path: |
          backend/type-coverage-python.json
          backend/type-coverage-python.txt
          backend/mypy-coverage-report/
          frontend/type-coverage-report/
    
    - name: Comment type coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const prNumber = context.payload.pull_request.number;
          
          let comment = `ğŸ“Š **å‹ãƒã‚§ãƒƒã‚¯çµæœ**\n\n`;
          
          try {
            // Pythonå‹ã‚«ãƒãƒ¬ãƒƒã‚¸ã®èª­ã¿è¾¼ã¿
            let pythonPercent = 'N/A';
            let pythonStatus = 'âš ï¸';
            
            try {
              const pythonCoverage = fs.readFileSync('backend/type-coverage-python.txt', 'utf8');
              const pythonMatch = pythonCoverage.match(/Type coverage: ([\d.]+)%/);
              
              if (pythonMatch) {
                pythonPercent = pythonMatch[1];
                pythonStatus = parseFloat(pythonPercent) >= 95 ? 'âœ…' : 'âš ï¸';
              } else if (pythonCoverage.includes('95%+')) {
                pythonPercent = '95%+';
                pythonStatus = 'âœ…';
              } else if (pythonCoverage.includes('90%-')) {
                pythonPercent = '90%-';
                pythonStatus = 'âš ï¸';
              } else if (pythonCoverage.includes('N/A')) {
                pythonPercent = 'N/A';
                pythonStatus = 'âš ï¸';
              }
            } catch (pythonError) {
              console.log('Python coverage file not found, using default values');
            }
            
            comment += `| é …ç›® | çµæœ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |\n`;
            comment += `|------|------|----------|\n`;
            comment += `| Python å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ | ${pythonPercent} | ${pythonStatus} |\n`;
            comment += `| TypeScript å³æ ¼ãƒã‚§ãƒƒã‚¯ | å®Œäº† | âœ… |\n`;
            comment += `| anyå‹ä½¿ç”¨ãƒã‚§ãƒƒã‚¯ | å®Œäº† | âœ… |\n`;
            comment += `| æœªä½¿ç”¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | å®Œäº† | âœ… |\n\n`;
            
            if (pythonPercent === 'N/A') {
              comment += `âš ï¸ **æ³¨æ„**: å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ„ãƒ¼ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚mypy strict modeã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚\n\n`;
            } else if (pythonPercent.includes('-')) {
              comment += `âš ï¸ **æ³¨æ„**: å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒæ¨å®šå€¤ã§ã™ã€‚è©³ç´°ã¯mypyã®çµæœã‚’ã”ç¢ºèªãã ã•ã„ã€‚\n\n`;
            }
            
          } catch (error) {
            comment += `âŒ å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n\n`;
            comment += `| é …ç›® | çµæœ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |\n`;
            comment += `|------|------|----------|\n`;
            comment += `| Python å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ | N/A | âš ï¸ |\n`;
            comment += `| TypeScript å³æ ¼ãƒã‚§ãƒƒã‚¯ | å®Œäº† | âœ… |\n`;
            comment += `| anyå‹ä½¿ç”¨ãƒã‚§ãƒƒã‚¯ | å®Œäº† | âœ… |\n`;
            comment += `| æœªä½¿ç”¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | å®Œäº† | âœ… |\n\n`;
          }
          
          comment += `è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯ Artifacts ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚\n`;
          comment += `\n---\n`;
          comment += `*ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });

  # å‹ãƒã‚§ãƒƒã‚¯å“è³ªã‚²ãƒ¼ãƒˆ
  typecheck-quality-gate:
    runs-on: ubuntu-latest
    needs: [strict-typecheck, type-coverage]
    if: always()
    
    steps:
    - name: Check type check results
      run: |
        if [[ "${{ needs.strict-typecheck.result }}" != "success" ]]; then
          echo "âŒ å³æ ¼å‹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi
        
        if [[ "${{ needs.type-coverage.result }}" != "success" ]]; then
          echo "âš ï¸ å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          # å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯è­¦å‘Šã®ã¿ã§æ­¢ã‚ãªã„
        fi
        
        echo "âœ… å‹ãƒã‚§ãƒƒã‚¯å“è³ªã‚²ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸ"