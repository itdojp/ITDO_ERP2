name: Development CI - Phase 1
on:
  push:
    branches: [ main, develop, feature/*, hotfix/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ğŸš¨ CRITICAL: å¤±æ•—æ™‚ãƒãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯
  core-foundation-tests:
    name: "ğŸ”¥ Core Foundation Tests (MUST PASS)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Start data services
        run: |
          make start-data
          sleep 10

      - name: Run Core Foundation Tests
        run: |
          cd backend
          echo "ğŸ§ª Running User Extended Model Tests..."
          uv run pytest tests/unit/models/test_user_extended.py -v --tb=short
          
          echo "ğŸ§ª Running User Repository Tests..."
          uv run pytest tests/unit/repositories/test_user_repository.py -v --tb=short
          
          echo "ğŸ§ª Running User Model Tests..."
          uv run pytest tests/unit/test_models_user.py -v --tb=short
          
          echo "ğŸ§ª Running Security Tests..."
          uv run pytest tests/unit/test_security.py -v --tb=short

      - name: Stop data services
        if: always()
        run: |
          make stop-data

  # ğŸ“‹ LINTING: å¤±æ•—æ™‚ãƒãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯
  code-quality:
    name: "ğŸ“‹ Code Quality (MUST PASS)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Run Ruff Linting
        run: |
          cd backend
          uv run ruff check . --ignore E501,N805,N818

      - name: Run Ruff Formatting Check
        run: |
          cd backend
          uv run ruff format --check .

      - name: Frontend Linting
        run: |
          cd frontend
          npm install
          npm run lint

  # âš ï¸ WARNING: å¤±æ•—ã—ã¦ã‚‚ç¶™ç¶š
  service-layer-tests:
    name: "âš ï¸ Service Layer Tests (WARNING)"
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Start data services
        run: |
          make start-data
          sleep 10

      - name: Run Service Layer Tests
        run: |
          cd backend
          echo "âš ï¸ Running Service Layer Tests (failures expected)..."
          uv run pytest tests/unit/services/ -v --tb=short || true
          echo "â„¹ï¸ Service layer test failures are tracked in separate issues"

      - name: Stop data services
        if: always()
        run: |
          make stop-data

  # ğŸ“Š COVERAGE: è­¦å‘Šã®ã¿
  test-coverage:
    name: "ğŸ“Š Test Coverage Report"
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Start data services
        run: |
          make start-data
          sleep 10

      - name: Generate Coverage Report
        run: |
          cd backend
          uv run pytest tests/unit/ --cov=app --cov-report=html --cov-report=term-missing || true
          echo "ğŸ“Š Coverage report generated (target: >80%)"

      - name: Stop data services
        if: always()
        run: |
          make stop-data

  # ğŸ¯ PHASE STATUS
  phase-status-check:
    name: "ğŸ¯ Phase 1 Status Check"
    runs-on: ubuntu-latest
    needs: [core-foundation-tests, code-quality]
    if: always()
    steps:
      - name: Phase 1 Status Report
        run: |
          echo "=== Phase 1: åŸºç›¤å®‰å®šæœŸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ==="
          echo "ğŸ”¥ Core Foundation Tests: ${{ needs.core-foundation-tests.result }}"
          echo "ğŸ“‹ Code Quality: ${{ needs.code-quality.result }}"
          
          if [[ "${{ needs.core-foundation-tests.result }}" == "success" && "${{ needs.code-quality.result }}" == "success" ]]; then
            echo "âœ… Phase 1 åŸºæº–ã‚¯ãƒªã‚¢: ãƒãƒ¼ã‚¸å¯èƒ½"
          else
            echo "âŒ Phase 1 åŸºæº–æœªé”: ãƒãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯"
            exit 1
          fi