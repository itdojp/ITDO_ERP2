name: Auto Review Request

on:
  pull_request:
    types: [opened, ready_for_review]

jobs:
  auto-assign-reviewers:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Add reviewers and labels
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const prNumber = context.payload.pull_request.number;
          const prAuthor = context.payload.pull_request.user.login;
          
          // ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆï¼ˆä½œæˆè€…ä»¥å¤–ï¼‰
          const teamMembers = [
            // ã“ã“ã«ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¿½åŠ 
            // 'member1', 'member2', 'member3'
          ];
          
          // ä½œæˆè€…ä»¥å¤–ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—
          const availableReviewers = teamMembers.filter(member => member !== prAuthor);
          
          // ãƒ©ãƒ³ãƒ€ãƒ ã«1äººé¸æŠï¼ˆãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã‚‹å ´åˆï¼‰
          let selectedReviewer = null;
          if (availableReviewers.length > 0) {
            selectedReviewer = availableReviewers[Math.floor(Math.random() * availableReviewers.length)];
          }
          
          try {
            // ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã‚’è¿½åŠ 
            const reviewers = [];
            if (selectedReviewer) {
              reviewers.push(selectedReviewer);
            }
            
            if (reviewers.length > 0) {
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number: prNumber,
                reviewers: reviewers
              });
              
              console.log(`Added reviewers: ${reviewers.join(', ')}`);
            }
            
            // å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ã„ã¦ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            const { data: files } = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: prNumber
            });
            
            const labels = [];
            const hasBackendChanges = files.some(file => file.filename.startsWith('backend/'));
            const hasFrontendChanges = files.some(file => file.filename.startsWith('frontend/'));
            const hasInfraChanges = files.some(file => file.filename.startsWith('infra/') || file.filename.includes('docker') || file.filename.includes('compose'));
            const hasDocsChanges = files.some(file => file.filename.startsWith('docs/') || file.filename.endsWith('.md'));
            const hasTestChanges = files.some(file => file.filename.includes('test') || file.filename.startsWith('e2e/'));
            
            if (hasBackendChanges) labels.push('backend');
            if (hasFrontendChanges) labels.push('frontend');
            if (hasInfraChanges) labels.push('infrastructure');
            if (hasDocsChanges) labels.push('documentation');
            if (hasTestChanges) labels.push('testing');
            
            // PRã‚¿ã‚¤ãƒˆãƒ«ã«WIPãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
            if (context.payload.pull_request.title.toLowerCase().includes('wip')) {
              labels.push('work-in-progress');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: labels
              });
              
              console.log(`Added labels: ${labels.join(', ')}`);
            }
            
            // æˆåŠŸã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            const comment = `ğŸ¤– **è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®šå®Œäº†**
            
${selectedReviewer ? `âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼è¿½åŠ : @${selectedReviewer}` : 'âš ï¸ åˆ©ç”¨å¯èƒ½ãªãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ãŒã„ã¾ã›ã‚“'}
${labels.length > 0 ? `âœ… ãƒ©ãƒ™ãƒ«è¿½åŠ : ${labels.join(', ')}` : ''}

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
1. Copilot Agentã«ã‚ˆã‚‹è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠå¾…ã¡ãã ã•ã„
2. ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜äº‹é …ãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ãã ã•ã„
3. å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒé€šã£ãŸã‚‰ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™

---
*ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: comment
            });
            
          } catch (error) {
            console.error('Error in auto-review-request:', error);
            
            // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            const errorComment = `âŒ **è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®šã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**
            
ã‚¨ãƒ©ãƒ¼å†…å®¹: ${error.message}

æ‰‹å‹•ã§ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

---
*ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: errorComment
            });
          }