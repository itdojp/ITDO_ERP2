name: Claude PM Automation System

on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    # æ¯æ™‚é–“å®Ÿè¡Œï¼ˆé€²æ—ç›£è¦–ï¼‰
    - cron: '0 * * * *'

jobs:
  claude-project-manager:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'claude-code-task')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude-pm')) ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'schedule')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Claude PM Analysis
        uses: grll/claude-code-action@beta
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          timeout: 300 # 5åˆ†é–“
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PM_MODE: ${{ github.event_name }}
          
  task-assignment:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Auto Task Assignment
        uses: actions/github-script@v7
        with:
          script: |
            // ã‚¿ã‚¹ã‚¯ã®è‡ªå‹•å‰²å½“ãƒ­ã‚¸ãƒƒã‚¯
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'cc01,cc02,cc03',
              state: 'open'
            });
            
            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥ã®ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰è¨ˆç®—
            const workload = {
              cc01: issues.filter(i => i.labels.some(l => l.name === 'cc01')).length,
              cc02: issues.filter(i => i.labels.some(l => l.name === 'cc02')).length,
              cc03: issues.filter(i => i.labels.some(l => l.name === 'cc03')).length
            };
            
            // æœ€å°ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é¸æŠ
            const minAgent = Object.keys(workload).reduce((a, b) => 
              workload[a] < workload[b] ? a : b
            );
            
            // ãƒ©ãƒ™ãƒ«è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [minAgent, 'auto-assigned']
            });
            
            // å‰²å½“ã‚³ãƒ¡ãƒ³ãƒˆ
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ¤– è‡ªå‹•å‰²å½“: ${minAgent.toUpperCase()} ã«å‰²ã‚Šå½“ã¦ã¾ã—ãŸ\n\nç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰:\n- CC01: ${workload.cc01}ä»¶\n- CC02: ${workload.cc02}ä»¶\n- CC03: ${workload.cc03}ä»¶`
            });

  progress-monitoring:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check Stalled Issues
        uses: actions/github-script@v7
        with:
          script: |
            // æ®µéšçš„åœæ»æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ 
            function getStallThreshold(issue) {
              const labels = issue.labels.map(l => l.name);
              
              // ãƒãƒ¼ãƒªãƒ³ã‚°é…å»¶(15åˆ†)ã‚’è€ƒæ…®ã—ãŸæ—©æœŸç™ºè¦‹è¨­å®š
              if (labels.includes('urgent') || labels.includes('critical')) {
                return 0.5; // 30åˆ† (å®Ÿå¿œç­”45åˆ†ä»¥å†…)
              } else if (labels.includes('feature') || labels.includes('large-task')) {
                return 6; // 6æ™‚é–“ (å®Ÿå¿œç­”6æ™‚é–“15åˆ†ä»¥å†…)  
              } else if (labels.includes('planning') || labels.includes('design')) {
                return 12; // 12æ™‚é–“ (å®Ÿå¿œç­”12æ™‚é–“15åˆ†ä»¥å†…)
              } else {
                return 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ2æ™‚é–“ (å®Ÿå¿œç­”2æ™‚é–“15åˆ†ä»¥å†…)
              }
            }
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'claude-code-task',
              state: 'open',
              sort: 'updated',
              direction: 'asc'
            });
            
            for (const issue of issues) {
              const updatedAt = new Date(issue.updated_at);
              const thresholdHours = getStallThreshold(issue);
              const thresholdTime = new Date(Date.now() - thresholdHours * 60 * 60 * 1000);
              
              if (updatedAt < thresholdTime) {
                const hoursSinceUpdate = Math.floor((Date.now() - updatedAt.getTime()) / (1000 * 60 * 60));
                const urgencyLevel = hoursSinceUpdate >= thresholdHours * 2 ? 'ğŸš¨ URGENT' : 'âš ï¸ æ³¨æ„';
                
                // ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—åˆ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const taskType = issue.labels.some(l => ['urgent', 'critical'].includes(l.name)) ? 'ç·Šæ€¥ã‚¿ã‚¹ã‚¯' :
                               issue.labels.some(l => ['feature', 'large-task'].includes(l.name)) ? 'å¤§è¦æ¨¡ã‚¿ã‚¹ã‚¯' :
                               issue.labels.some(l => ['planning', 'design'].includes(l.name)) ? 'è¨ˆç”»ãƒ»è¨­è¨ˆã‚¿ã‚¹ã‚¯' : 'é€šå¸¸ã‚¿ã‚¹ã‚¯';
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `${urgencyLevel} **æ—©æœŸç™ºè¦‹: ${taskType}**\n\nğŸ“Š **æ¤œå‡ºçŠ¶æ³:**\n- æœ€çµ‚æ›´æ–°: ${hoursSinceUpdate}æ™‚é–“å‰\n- æ¤œå‡ºåŸºæº–: ${thresholdHours}æ™‚é–“\n- å®Ÿå¿œç­”æ™‚é–“: æœ€å¤§+15åˆ† (ãƒãƒ¼ãƒªãƒ³ã‚°é…å»¶)\n\nğŸ¤ **ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒ¼ãƒˆ:**\n- é †èª¿ã«é€²ã‚“ã§ã„ã¾ã™ã‹ï¼Ÿ\n- ä½•ã‹ã‚µãƒãƒ¼ãƒˆã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ\n- ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ãŒã‚ã‚Œã°æ—©ã‚ã«ãŠçŸ¥ã‚‰ã›ãã ã•ã„\n- é€²æ—ã®ç°¡å˜ãªå ±å‘Šã‚’ãŠé¡˜ã„ã—ã¾ã™\n\nğŸ’¡ **è¿”ä¿¡ä¾‹:** "é †èª¿ã§ã™" / "â—‹â—‹ã§å›°ã£ã¦ã„ã¾ã™" / "ã‚ã¨â—‹æ™‚é–“ã§å®Œäº†äºˆå®š"\n\n---\nğŸ¤– æ—©æœŸç™ºè¦‹&ã‚µãƒãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ `
                });
              }
            }

  ci-failure-support:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Wait for CI completion
        run: sleep 60
        
      - name: Check CI Status and Provide Support
        uses: actions/github-script@v7
        with:
          script: |
            // CIçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });
            
            const failedChecks = checks.check_runs.filter(
              check => check.conclusion === 'failure'
            );
            
            if (failedChecks.length > 0) {
              const failureDetails = failedChecks.map(check => 
                `- **${check.name}**: [è©³ç´°](${check.html_url})`
              ).join('\n');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `ğŸ”§ **CIå¤±æ•—ã‚’æ¤œå‡ºã—ã¾ã—ãŸ**\n\n### å¤±æ•—ã—ãŸãƒã‚§ãƒƒã‚¯\n${failureDetails}\n\n### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª\n2. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n3. ä¿®æ­£ã‚’ãƒ—ãƒƒã‚·ãƒ¥\n\n### ã‚ˆãã‚ã‚‹è§£æ±ºæ–¹æ³•\n- **å‹ã‚¨ãƒ©ãƒ¼**: \`npm run typecheck\`\n- **ãƒ†ã‚¹ãƒˆå¤±æ•—**: \`npm test\` ã¾ãŸã¯ \`uv run pytest\`\n- **Linté•å**: \`npm run lint:fix\`\n\n---\nğŸ¤– PMè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ `
              });
            }