# language: ja
機能: 認証・認可システム
  ITDO ERPシステムへの安全なアクセス制御を実現し、
  企業の機密情報を保護しながら、ユーザーの利便性を確保する

  背景:
    前提 システムが起動している
    かつ Keycloakが正常に動作している

  シナリオ: メールアドレスとパスワードによる基本認証（社内ネットワーク）
    前提 ユーザー "user@example.com" がパスワード "SecurePass123!" で登録されている
    かつ 社内ネットワーク（IPアドレス: 192.168.1.100）からアクセスしている
    
    もし ユーザーがログインページにアクセスする
    かつ メールアドレス "user@example.com" を入力する
    かつ パスワード "SecurePass123!" を入力する
    かつ ログインボタンをクリックする
    
    ならば システムはユーザーを認証する
    かつ JWTアクセストークンが発行される
    かつ セッション有効期限は8時間に設定される
    かつ ダッシュボードページにリダイレクトされる
    かつ MFAは要求されない

  シナリオ: Googleアカウントによる SSO認証
    前提 ユーザー "user@example.com" がGoogleアカウントと連携済みである
    
    もし ユーザーがログインページにアクセスする
    かつ "Googleでログイン" ボタンをクリックする
    かつ Googleの認証画面でログインを完了する
    
    ならば システムはOAuth2.0経由でユーザーを認証する
    かつ JWTアクセストークンが発行される
    かつ ダッシュボードページにリダイレクトされる

  シナリオ: 社外からの新規ログインでMFA必須
    前提 ユーザー "user@example.com" がパスワード "SecurePass123!" で登録されている
    かつ Google Authenticatorが設定済みである
    かつ 社外ネットワーク（IPアドレス: 203.0.113.10）からアクセスしている
    
    もし ユーザーがログインページにアクセスする
    かつ メールアドレス "user@example.com" を入力する
    かつ パスワード "SecurePass123!" を入力する
    かつ ログインボタンをクリックする
    
    ならば システムは一次認証を成功させる
    かつ MFA入力画面が表示される
    
    もし ユーザーがGoogle Authenticatorで生成された6桁のコード "123456" を入力する
    かつ 確認ボタンをクリックする
    
    ならば システムはTOTPコードを検証する
    かつ 二次認証が成功する
    かつ JWTアクセストークンが発行される
    かつ ダッシュボードページにリダイレクトされる

  シナリオ: ユーザーによるセッション時間のカスタマイズ
    前提 ユーザー "user@example.com" としてログイン済みである
    
    もし ユーザーがアカウント設定ページにアクセスする
    かつ セッション設定タブを選択する
    かつ セッション有効期限を "4時間" に変更する
    かつ 保存ボタンをクリックする
    
    ならば 設定が保存される
    かつ 次回ログイン時からセッション有効期限が4時間になる
    かつ 確認メッセージ "セッション設定を更新しました" が表示される

  シナリオ: 管理者によるユーザーセッション監視
    前提 管理者 "admin@example.com" としてログイン済みである
    
    もし 管理者が管理画面の "アクティブセッション" ページにアクセスする
    
    ならば 現在アクティブな全ユーザーセッションの一覧が表示される
    かつ 各セッションには以下の情報が含まれる:
      | ユーザー名 | ログイン時刻 | 最終アクセス時刻 | セッション残り時間 | IPアドレス |
    かつ セッションを強制終了するボタンが表示される

  シナリオ: パスワードリセット（メール経由）
    前提 ユーザー "user@example.com" が登録されている
    
    もし ユーザーがログインページの "パスワードを忘れた方" リンクをクリックする
    かつ メールアドレス "user@example.com" を入力する
    かつ 送信ボタンをクリックする
    
    ならば システムはパスワードリセット用のトークンを生成する
    かつ リセットリンクを含むメールが送信される
    かつ 画面に "メールを送信しました" と表示される
    
    もし ユーザーがメール内のリセットリンクをクリックする
    かつ 新しいパスワード "NewSecurePass456!" を入力する
    かつ パスワード確認欄に同じパスワードを入力する
    かつ 変更ボタンをクリックする
    
    ならば パスワードが更新される
    かつ ログインページにリダイレクトされる
    かつ "パスワードを変更しました" と表示される

  シナリオ: アイドルタイムアウトによる自動ログアウト
    前提 ユーザー "user@example.com" としてログイン済みである
    かつ アイドルタイムアウトは30分に設定されている
    
    もし ユーザーが30分間操作を行わない
    
    ならば システムは自動的にセッションを終了する
    かつ ユーザーはログインページにリダイレクトされる
    かつ "セッションがタイムアウトしました" と表示される

  シナリオ: ログイン失敗によるアカウントロック
    前提 ユーザー "user@example.com" が登録されている
    
    もし ユーザーが誤ったパスワードで5回連続ログインを試みる
    
    ならば アカウントが30分間ロックされる
    かつ "アカウントが一時的にロックされています" と表示される
    かつ 管理者に通知メールが送信される